%% -*- tab-width: 4;erlang-indent-level: 4;indent-tabs-mode: nil -*-
%% ex: ft=erlang ts=4 sw=4 et
%
{erl_opts, [debug_info]}.

{deps, [
        {jiffy,  ".*",
         {git, "https://github.com/barrel-db/jiffy.git",
          {tag, "0.14.3-barreldb.1"}}},

        {snappy, ".*",
         {git, "https://github.com/rcouch/snappy.git",
          {tag, "1.1.0"}}},

        {lager, ".*",
         {git, "https://github.com/basho/lager.git",
          {tag, "2.1.0"}}},

        {ucol_nif, ".*",
         {git, "https://github.com/refuge/ucol_nif.git",
          {tag, "1.1.1"}}},

        {gproc, ".*",
         {git, "https://github.com/uwiger/gproc.git",
          {tag, "0.5"}}},

        {mochiweb,  ".*",
         {git, "https://github.com/mochi/mochiweb.git",
          {tag, "v2.12.2"}}},

        {oauth,  ".*",
         {git, "https://github.com/rcouch/couchdb-oauth",
          {tag, "1.3.0"}}},

        {ibrowse, ".*",
         {git, "https://github.com/cmullaparthi/ibrowse",
          {tag, "v4.2"}}},

        {hackney, ".*",
         {git, "https://github.com/benoitc/hackney",
          {tag, "1.2.0"}}}

       ]}.

{pre_hooks, [{"(linux|darwin|solaris)", compile, "make -C apps/couch/c_src/couch_js"},
             {"(freebsd|netbsd|openbsd)", compile, "gmake -C apps/couch/c_src/couch_js"}]}.

{post_hooks, [{"(linux|darwin|solaris)", clean, "make -C apps/couch/c_src/couch_js clean"},
              {"(freebsd|netbsd|openbsd)", compile, "gmake -C apps/couch/c_src/couch_js clean"},
              {compile, "escript support/build_js.escript"}]}.

{relx, [
        {release, {'barrel', "011"},
         [lager,
          sasl,
          public_key,
          ssl,
          crypto,
          os_mon,
          inets,
          runtime_tools,
          mochiweb,
          ibrowse,
          hackney,
          couch,
          couch_index,
          couch_httpd,
          couch_mrview,
          couch_changes,
          couch_replicator,
          couch_randomdoc,
          couch_dbupdates,
          geocouch]},

        {sys_config, ""},

        {vm_args, ""},

        {dev_mode, true},
        {include_erts, false},
        {extended_start_script, true},

        {overlay_vars, "config/vars.config"},

        {overlay, [
                   {mkdir, "log"},
                   {mkdir, "run"},
                   {mkdir, "data"},

                   %% keep empty files
                   {copy, "config/empty", "log/KEEP"},
                   {copy, "config/empty", "data/KEEP"},


                   %% config files
                   {template, "config/sys.config", "releases/{{rel_vsn}}//sys.config"},
                   {template, "config/vm.args", "releases/{{rel_vsn}}/vm.args"},
                   {template, "config/couch.ini", "etc/couch.ini"},
                   {template, "config/local.ini", "etc/local.ini"},

                   %% couchdb data files
                   {mkdir, "share"},
                   {mkdir, "share/server"},
                   {copy, "share/server/main.js", "share/server"},
                   {copy, "share/server/main-coffee.js", "share/server"},
                   {copy, "share/www", "share"}

                  ]}
       ]}.

{profiles, [{prod, [{relx, [{dev_mode, false},
                            {include_erts, true}]}]
            }]
}.
